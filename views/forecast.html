<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forecast</title>
  <link rel="stylesheet" href="css/style.css" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<body>
  <header>
    <nav class="bg-gray-900 p-4">
      <div class="mx-auto flex justify-between">
        <a class="text-white text-xl font-bold">Aurora Explorer-Forecast</a>

        <!--Navbar Menu-->
        <button id="menuToggle" class="md:hidden text-white focus:outline-none">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>

        <!--Menu Items-->
        <div id="menu" class="hidden md:flex space-x-6">
          <a href="/" class="text-white hover:text-gray-400">Home</a>
          <a href="/forecast.html" class="text-white hover:text-gray-400">Forecast</a>
          <a href="/gallery.html" class="text-white hover:text-gray-400">Gallery</a>
          <a href="/guide.html" class="text-white hover:text-gray-400">Guide</a>
        </div>
      </div>

      <!--Mobile Menu-->
      <div id="mobileMenu" class="md:hidden hidden">
        <a href="/" class="block text-white px-4 py-2 hover:bg-gray-900">Home</a>
        <a href="/forecast.html" class="block text-white px-4 py-2 hover:bg-gray-700">Forecast</a>
        <a href="/gallery.html" class="block text-white px-4 py-2 hover:bg-gray-700">Gallery</a>
        <a href="/guide.html" class="block text-white px-4 py-2 hover:bg-gray-700">Guide</a>
      </div>
    </nav>

    <script>
      const menuToggle = document.getElementById('menuToggle');
      const mobileMenu = document.getElementById('mobileMenu');

      menuToggle.addEventListener('click', () => {
        mobileMenu.classList.toggle('hidden');
      });
    </script>
  </header>

  <div class="min-h-screen bg-gray-800 flex flex-col items-center justify-center text-white">
    <main class="container mx-auto p-4 md:w-3/5 w-full">
      <h2 class="hidden md:block text-4xl md:text-6xl font-bold mb-4 text-center ">Aurora Forecast</h2>
  
      <div class="flex flex-col items-center justify-center space-y-6">
  
        <!-- Kp Index Forecast Chart -->
        <div class="w-full max-w-3xl bg-gray-800 rounded-lg shadow-lg p-6 md:p-8 mb-6">
          <h3 class="text-2xl md:text-3xl font-bold text-center text-white mb-4 md:mb-6">Kp Index Forecast</h3>
          <div class="flex justify-center items-center bg-gray-700 p-4 md:p-6 rounded-lg shadow-inner">
            <!-- Chart with increased height on smaller screens -->
            <canvas id="kpChart" class="w-full max-w-xs md:max-w-lg h-64 sm:h-80 md:h-64"></canvas>
          </div>
        </div>
  
        <!-- Aurora Map -->
        <h3 class="text-xl md:text-2xl font-bold mb-2 text-center">Aurora Map</h3>
        <div class="w-full max-w-3xl bg-gray-700 rounded shadow-md p-4 md:p-6">
          <div id="map" class="h-64 md:h-96 w-full"></div>
        </div>
      </div>
    </main>
  </div>
  

  <script>
    async function fetchKpForecast() {
      try {
        const response = await fetch('https://services.swpc.noaa.gov/text/3-day-forecast.txt');

        if (!response.ok) {
          throw new Error('Network connection was not estabilished');
        }

        const textData = await response.text();
        const lines = textData.split('\n');

        const timeKpMap = {};

        // Filter text file returned by API and put values in timeKpMap
        for (const line of lines) {
          if (line.includes('NOAA Kp index breakdown')) {
            continue; // Skip the header line
          }

          const match = line.match(/(\d{2}-\d{2}UT)\s+([\d.]+)/);
          if (match) {
            const time = match[1].trim();
            const kpIndex = Math.round(parseFloat(match[2].trim()));

            timeKpMap[time.slice(0,-2)] = kpIndex; // Use UTC time as the key
          }
        }

        console.log(timeKpMap);
        renderChart(timeKpMap);

      } catch (error) {
        console.error('Error fetching Kp forecast data:', error);
      }
    }

    function getColor(kpIndex) {
      if (kpIndex <= 3) return 'rgba(0, 255, 0, 0.8)';
      if (kpIndex = 4) return 'rgba(255, 255, 0, 0.8)';
      if (kpIndex <= 6) return 'rgba(255, 165, 0, 0.8)';
      if (kpIndex <= 9) return 'rgba(255, 0, 0, 0.8)';
      return 'rgba(0, 0, 0, 0.8)';
    }

    function renderChart(timeKpMap) {

      const ctx = document.getElementById('kpChart').getContext('2d');
      const labels = Object.keys(timeKpMap);
      const data = Object.values(timeKpMap);

      const backgroundColors = data.map(kpIndex => getColor(kpIndex));
      Chart.defaults.color = '#D2D2D2';
      const myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Kp Index',
            data: data,
            backgroundColor: backgroundColors,
            borderColor: backgroundColors,
            borderWidth: 1
          }]
        },
        options: {
            plugins: {
                legend: {
                    display: false,
                    labels:{
                      color: 'rgb(210,210,210)'
                    }
                }
                
            },
          scales: {
            y: {
              beginAtZero: true,
              max: 9,
              title: {
                display: true,
                text: 'Kp Index'
              },
            },
            x: {
              title: {
                display: true,
                text: 'Time (UTC)'
              }
            }
          }
        }
      });
    }
    document.addEventListener('DOMContentLoaded', (event) => {

      fetchKpForecast();

    });
  </script>
</body>

</html>